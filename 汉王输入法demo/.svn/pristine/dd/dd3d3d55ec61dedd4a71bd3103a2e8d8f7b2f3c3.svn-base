//
//  GZCandidateBarView.m
//  HanvonKeyboard
//
//  Created by hanvon on 2017/11/4.
//  Copyright © 2017年 hanvon. All rights reserved.
//

#import "GZCandidateBarView.h"


@interface GZCandidateBarView()<UIScrollViewDelegate>
@property (nonatomic,strong) NSArray *data;
@property (nonatomic,assign) BOOL isShowMore; //是否是展示更多候选 状态
@end


@implementation GZCandidateBarView

- (instancetype)initWithFrame:(CGRect)frame {
    self = [super initWithFrame:frame];
    if (self) {
        //创建view
        self.backgroundColor = [UIColor whiteColor];
        self.layer.borderWidth = 0.5;
        self.layer.borderColor = [RGBA(210, 213, 219, 1.0) CGColor];

        _isShowMore = NO;
        //创建固定view
        [self createFixedUI];
    }
    return self;
}

//改变拼音
- (void)changeShowPinyin:(NSString *)pinyin {

    if (!pinyin || pinyin.length == 0) {
        UILabel *PinyinLabel = (UILabel*)[self viewWithTag:10];
        [PinyinLabel removeFromSuperview];
        return;
    }

    CGFloat left = 7.0;
    CGFloat height = self.frame.size.height/3.0; //拼音的高度
    CGFloat showButtonH = self.frame.size.height; //展开更多的宽高

    //拼音label
    UILabel *PinyinLabel = (UILabel*)[self viewWithTag:10];
    if (!PinyinLabel) {
        PinyinLabel = [[UILabel alloc] initWithFrame:CGRectMake(left, 0, self.frame.size.width-showButtonH-left, height)];
        PinyinLabel.backgroundColor = [UIColor whiteColor];
        PinyinLabel.font = [UIFont systemFontOfSize:11];
        PinyinLabel.textAlignment = NSTextAlignmentLeft;
        PinyinLabel.textColor = [UIColor blackColor];
        PinyinLabel.text = pinyin;
        [self addSubview:PinyinLabel];
        PinyinLabel.tag = 10;
    }else {
        PinyinLabel.text = pinyin;
    }

    //固定view在最上层
    [self setToFront];
}

//改变候选的展示内容
- (void)changeShowText:(NSArray*)textArr {

    UIScrollView *candidateView = (UIScrollView*)[self viewWithTag:6];
    for (UIView *bbt in candidateView.subviews) {
        if ([bbt isKindOfClass:[UIButton class]]) {
            [bbt removeFromSuperview];
        }
    }

    if (!textArr || textArr.count == 0) {
        return;
    }

    _data = [textArr copy];

    CGFloat left = 7.0;
    CGFloat height = (self.frame.size.height/3.0)*2.0; //候选按钮的高度
    CGFloat y = self.frame.size.height - height; //候选按钮的y
    CGFloat space = 20.0; //候选按钮的间距
    UIFont *font = [UIFont systemFontOfSize:16]; //按钮字号
    CGFloat showButtonH = self.frame.size.height; //展开更多按钮的宽高
    CGFloat candidateShowWidth = self.frame.size.width - showButtonH; //候选区域的总宽度

    //按钮的父视图
    if (!candidateView) {
        candidateView = [[UIScrollView alloc] initWithFrame:CGRectMake(0, y, candidateShowWidth, height)];
        candidateView.contentOffset = CGPointMake(0, 0);
        candidateView.bounces = YES;
        candidateView.showsHorizontalScrollIndicator = NO; //水平
        candidateView.showsVerticalScrollIndicator = NO; //垂直
        candidateView.pagingEnabled = NO;
        candidateView.delegate = self;
        candidateView.backgroundColor = [UIColor whiteColor];
        [self addSubview:candidateView];
        candidateView.tag = 6;
    }


    //候选按钮
    for (int i=0; i<textArr.count; i++) {
        CGSize size = [[GZPublicMethod sharedPublicMethod] getStringSize:textArr[i] withFont:font wordSpace:@(3) lineSpace:3.0];
        //CGFloat width = [[GZPublicMethod sharedPublicMethod] widthForString:textArr[i] font:font andHeight:height]; //字符串的宽度
        GZFunctionButton *button = [GZFunctionButton buttonWithType:UIButtonTypeCustom];
        button.frame = CGRectMake(left, 0, size.width, height); //width*1.4
        [button setTitle:textArr[i] forState:UIControlStateNormal];
        //[button sizeToFit];
        //button.contentHorizontalAlignment = UIControlContentHorizontalAlignmentLeft;
        button.backgroundColor = [UIColor clearColor];
        [button setViewType];
        [button setTitleColor:[UIColor blackColor] forState:UIControlStateNormal];
        button.tag = 130 + i;
        [button addTarget:self action:@selector(buttonClickAction:) forControlEvents:UIControlEventTouchUpInside];
//        [button addTarget:self action:@selector(buttonClickCancel:) forControlEvents:UIControlEventTouchDragInside]; //移动手指出按钮
        [candidateView addSubview:button];

        button.layer.shadowColor = [UIColor blackColor].CGColor;
        button.layer.shadowOpacity = 1.0;
        button.layer.shadowOffset = CGSizeMake(0, 3);
        button.layer.shadowRadius = 5;
//        button.layer.shadowPath = [UIBezierPath bezierPathWithRect:button.bounds].CGPath;
        CGFloat buttonW = button.frame.size.width;
        left = left + buttonW + space;


        //设置滚动视图的宽
        if (i == textArr.count - 1) {
            CGFloat lastW = size.width;
            candidateView.contentSize = CGSizeMake(left+lastW,height);
        }
    }




    //固定view在最上层
    [self setToFront];
}

//是否存在候选内容
- (BOOL)isTabBarHasData {
    for (UIButton *bbt in self.subviews) {
        if (bbt) {
            return YES;
        }
    }
    return NO;
}

//是否有拼音
- (BOOL)isTabBarHasPinyin {
    UILabel *PinyinLabel = (UILabel*)[self viewWithTag:10];
    if (PinyinLabel.text != nil && PinyinLabel.text.length != 0) {
        return YES;
    }
    return NO;
}


//改变展示更多 按钮   0收起 1展示更多
- (void)changeShowMoreButton:(int)type {
    UIButton *moreButton = (UIButton*)[self viewWithTag:7];
    if (!moreButton) {
        return;
    }

    if (type == 0) {
        //收起
        _isShowMore = NO;
        [moreButton setImage:[UIImage imageNamed:@"keyboard_down"] forState:UIControlStateNormal];
    }else if (type == 1) {
        //展开
        _isShowMore = YES;
        [moreButton setImage:[UIImage imageNamed:@"keyboard_up"] forState:UIControlStateNormal];
    }else {

    }
}

//获取候选内容
- (NSArray*)getCadidateArray {
    return _data;
}

//切换横竖屏时，传入的新高度
- (void)changeViewFrame:(CGRect)newFrame {

    self.frame = newFrame;

    //展开候选
    UIButton *showButton = (UIButton*)[self viewWithTag:7];
    CGFloat showButtonH = self.frame.size.height;
    CGFloat showButtonX = newFrame.size.width - showButtonH;
    showButton.frame = CGRectMake(showButtonX, 0, showButtonH, showButtonH);

    //候选、拼音 分割线
    UILabel *line = (UILabel*)[self viewWithTag:8];
    line.frame = CGRectMake(0, line.frame.origin.y, newFrame.size.width-showButtonH, 0.5);

    //拼音
    UILabel *PinyinLabel = (UILabel*)[self viewWithTag:10];
    CGRect frame = PinyinLabel.frame;
    PinyinLabel.frame = CGRectMake(frame.origin.x, frame.origin.y, newFrame.size.width-showButtonH-frame.origin.x, frame.size.height);

    //候选
    UIScrollView *candidateView = (UIScrollView*)[self viewWithTag:6];
    candidateView.frame = CGRectMake(0, candidateView.frame.origin.y, newFrame.size.width-showButtonH, candidateView.frame.size.height);
}

//点击删除键 删除第一个候选内容的 最后一个字符（手写键盘专用）
- (void)deleteBackwardActionByNowCandidates:(NSArray*)texArr complation:(SuccesDeleteBackwardBlock)data {

    NSMutableArray *newTexArr = [[NSMutableArray alloc] init];

    if (!texArr || texArr.count == 0) {

        UIScrollView *candidateView = (UIScrollView*)[self viewWithTag:6];

        for (UIView *bbt in candidateView.subviews) {
            if ([bbt isKindOfClass:[UIButton class]]) {
                UIButton *button = (UIButton*)bbt;
                NSString *text = button.titleLabel.text;
                [newTexArr addObject:text];
            }
        }
    }else {
        newTexArr = [texArr mutableCopy];
    }

    //候选框没有任何候选内容
    if (newTexArr.count == 0 || !newTexArr) {
        data(YES,YES);//第一个候选  只有一个字符  直接移除当前候选框
        return;
    }


    NSString *first = [newTexArr objectAtIndex:0];
    if (first.length <= 1) {
        data(YES,YES);//第一个候选  只有一个字符  直接移除当前候选框
        return;
    }

    NSString *newFirst = [first substringToIndex:first.length-1];
    [newTexArr replaceObjectAtIndex:0 withObject:newFirst];

    [self changeShowText:newTexArr];
    data(YES,NO);
}

#pragma mark -- UI
//候选框
- (void)createFixedUI {
    //展开候选
    CGFloat showButtonH = self.frame.size.height; //展开更多的宽高
    CGFloat showButtonX = self.frame.size.width - showButtonH;
    GZFunctionButton *showButton = (GZFunctionButton*)[self viewWithTag:7];
    if (!showButton) {
        showButton = [GZFunctionButton buttonWithType:UIButtonTypeCustom];
        showButton.backgroundColor = [UIColor whiteColor];
        showButton.layer.borderWidth = 0.5;
        showButton.layer.borderColor = [RGBA(210, 213, 219, 1.0) CGColor];
        showButton.frame = CGRectMake(showButtonX, 0, showButtonH, showButtonH);
        [showButton addTarget:self action:@selector(showMoreTap:) forControlEvents:UIControlEventTouchUpInside];
        [self addSubview:showButton];
        showButton.tag = 7;

        [showButton setImage:[UIImage imageNamed:@"keyboard_down"] forState:UIControlStateNormal];
    }

    CGFloat height = self.frame.size.height/3.0; //拼音的高度

    //分割线
    UILabel *line = (UILabel*)[self viewWithTag:8];
    if (!line) {
        line = [[UILabel alloc] initWithFrame:CGRectMake(0, height, self.frame.size.width-showButtonH, 0.5)];
        line.backgroundColor = RGBA(210, 213, 219, 1);
        [self addSubview:line];
        line.tag = 8;
    }
}

#pragma mark -- private
//选择候选内容
- (void)buttonClickAction:(UIButton*)tap {
    UIButton *butt = (UIButton*)tap;
    NSString *str = butt.titleLabel.text;
    if (self.sendSelectedStr) {
        self.sendSelectedStr(str, (int)butt.tag-130);
    }
}
//移动手指 取消点击
//- (void)buttonClickCancel:(UIButton*)tap {
//
//}

//点击展示更多
- (void)showMoreTap:(UIButton*)tap {

    UIButton *moreButton = (UIButton*)[self viewWithTag:7];

    _isShowMore = !_isShowMore;

    if (_isShowMore) {
        //展示
        [moreButton setImage:[UIImage imageNamed:@"keyboard_up"] forState:UIControlStateNormal];
        if (_data && self.sendShowMoreFunc) {
            self.sendShowMoreFunc(YES,_data);
        }
    }else {
        //收起
        [moreButton setImage:[UIImage imageNamed:@"keyboard_down"] forState:UIControlStateNormal];
        if (self.sendShowMoreFunc) {
            self.sendShowMoreFunc(NO,nil);
        }
    }
//    if (_isShowMore) {
//        //展示状态
//        [UIView transitionWithView:moreButton
//                          duration:0.5f
//                           options:UIViewAnimationOptionTransitionFlipFromTop
//                        animations:^ {
//                            [moreButton setImage:[UIImage imageNamed:@"keyboard_up"] forState:UIControlStateNormal];
//
//                        }completion:^ (BOOL finished){
//                            if (_data && self.sendShowMoreFunc) {
//                                self.sendShowMoreFunc(YES,_data);
//                            }
//                        }];
//
//    }else{
//        //收起状态
//        [UIView transitionWithView:moreButton
//                          duration:0.5f
//                           options:UIViewAnimationOptionTransitionFlipFromBottom
//                        animations:^ {
//                            [moreButton setImage:[UIImage imageNamed:@"keyboard_down"] forState:UIControlStateNormal];
//
//                        }completion:^ (BOOL finished){
//                            if (self.sendShowMoreFunc) {
//                                self.sendShowMoreFunc(NO,nil);
//                            }
//                        }];
//    }
}

//固定view在最上层
- (void)setToFront {
    UIButton *showButton = (UIButton*)[self viewWithTag:7];
    UILabel *line = (UILabel*)[self viewWithTag:8];
    [self bringSubviewToFront:showButton];
    [self bringSubviewToFront:line];
}


- (void)dealloc {
    NSLog(@"候选框 销毁");
    for (UIView *view in self.subviews) {
        [view removeFromSuperview];
    }

    UIScrollView *candidateView = (UIScrollView*)[self viewWithTag:6];
    for (UIView *bbt in candidateView.subviews) {
        if ([bbt isKindOfClass:[UIButton class]]) {
            [bbt removeFromSuperview];
        }
    }

    UIButton *showButton = (UIButton*)[self viewWithTag:7];
    if (showButton) {
        [showButton removeFromSuperview];
        showButton = nil;
    }

    //分割线
    UILabel *line = (UILabel*)[self viewWithTag:8];
    if (line) {
        [line removeFromSuperview];
        line = nil;
    }
    //候选按钮
    for (int i=0; i<100; i++) {
        UIButton *button = (UIButton*)[self viewWithTag:130 + i];
        if (button) {
            [button removeFromSuperview];
            button = nil;
        }
    }
}

@end
